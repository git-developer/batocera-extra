= batocera-extra
:url-batocera: https://github.com/batocera-linux/batocera.linux/
Extended motion and touch control for batocera
:toc: preamble
:toclevels: 4

This project is a proof of concept to play games with motion and touch control in the retro gaming distribution {url-batocera}[batocera].

## Project status

This project should be considered experimental. It demonstrates how motion and touch control can be added to batocera.
Installation requires command line access to batocera through a SSH shell.
Main goal of this project is to properly integrate the features into the core of batocera in the future.

The project is tested against the x86_64 platform. There are no hard dependencies on this architecture,
so it may well run on other architectures, too, but this is currently untested.

## Installation

. Open a shell on the batocera host
.. either via SSH
.. or by pressing F1 in the main menu to open the file manager and then F4 to open a terminal
. Copy this directory to `/userdata/extra` to your batocera host:
+
[source,console]
----
$ mkdir -p /userdata/extra && wget -O - https://github.com/git-developer/batocera-extra/tarball/main | gunzip | tar x --strip-components 1 -C /userdata/extra
----
. Register the desired features as batocera service.
.. (Optional)
+
By default, all features are registered. If you'd like to shorten the list of available services, you can exclude a feature by running:
+
[source,console]
----
$ /userdata/extra/<feature>/service hide
----
.. Register features and activate patches (required for Cemu and Citra):
+
[source,console]
----
$ /userdata/extra/bin/extra-services register
$ batocera-services enable extra_patches
$ batocera-services start extra_patches
----
. Enable the features you're interested according to section <<Configuration>>.

## Configuration
The configuration is applied by activating a motion service from the Main Menu / System Settings / Services:

image::services.png[]

[NOTE]
====
- The configuration has to be performed once only, it will be persisted across boots and batocera updates.

- Make sure that _extra_patches_ is enabled as batocera service.
The configuration generators for Cemu and Citra in current batocera don't offer support for motion and touch control.
Thus, the included patches are required to be started as batocera service.
====

Each time a service is started (manually or on boot), it will check for updates of the provider and download it to a cache directory if required, then install it and start it as background daemon.

Each time a motion service is started or stopped, the batocera configuration is updated so that Cemu and Citra will read

* motion input from the first enabled motion provider (i.e. top-most in the Services menu) and
* touch input from the emulator window.

## Features
### Motion Providers

.Supported motion providers
|===
|Controller |Batocera Service |Connection|Motion Provider|UDP Port|Log file (in `/userdata/system/logs`)|Comment

|Devices with modern Linux drivers
|MOTION_EVDEV
|USB, Bluetooth
|https://github.com/v1993/evdevhook2[evdevhook2]
| 26766
| `motion_evdev.log`
|Recommended. Supports many devices incl. Nintendo and Sony controllers.

|Nintendo Switch Controllers
|MOTION_NINTENDO
|USB, Bluetooth
|https://github.com/joaorb64/joycond-cemuhook[joycond-cemuhook]
| 26761
| `motion_nintendo.log`
| Supports Switch Pro Controllers and Joycons.

|Sony Controllers
|MOTION_SONY
|USB, Bluetooth
|https://github.com/lirannl/dsdrv-cemuhook[dsdrv-cemuhook]
| 26762
| `motion_sony.log`
| Supports Sony DualShock 4 and DualSense 5.

|Steam Controller
|MOTION_STEAM_CONTROLLER
|Dongle
|https://github.com/kozec/sc-controller[sc-controller]
| 26760
| `motion_steam_controller.log`
|Supports touch via link:motion_steam_controller/README.adoc[button mapping profiles]

|Steam Deck
|MOTION_STEAM_DECK
|native
|https://github.com/kmicki/SteamDeckGyroDSU[SteamDeckGyroDSU]
| 26767
| `motion_steam_deck.log`
|

|Nintendo Wiimote
|MOTION_WIIMOTE
|Bluetooth
|https://github.com/v1993/linuxmotehook2[linuxmotehook2]
| from configuration
| `motion_wiimote-PROFILE.log`
|Requires link:motion_wiimote/README.adoc[configuration]

|Remote devices (e.g. smartphones)
|MOTION_REMOTE
|HTTP
|any
| from configuration
| _none_
|Requires link:motion_remote/README.adoc[configuration].

|===

To use a motion provider with an emulator other than Cemu or Citra, configure the emulator to listen to `localhost` and the provider's UDP port. The https://github.com/joaorb64/joycond-cemuhook/wiki[joycond-cemuhook wiki] has detailed explanations for popular emulators.

#### Implementation details

Whenever a motion provider is started or stopped, the following settings are written to the batocera configuration file:

./userdata/system/batocera.conf
----
3ds.citra_motion_device=engine:cemuhookudp
3ds.citra_touch_device=engine:emu_window
3ds.citra_udp_input_address=<provider-host>
3ds.citra_udp_input_port=<provider-port>

wiiu.cemu_touchpad=1
wiiu.cemuhook_server_ip=<provider-host>
wiiu.cemuhook_server_port=<provider-port>
----

The host is `localhost` unless you run a remote provider (on a smartphone). The port is read from the first enabled service.

### Touch Providers
.Supported touch providers
|===
|Controller |Batocera Service |Touch Provider|Details

|Local devices (e.g. mouse)
|_none_
|_none_
|No configuration required.

|Sony controllers (DS4, DS5)
|_none_
|_none_
|No configuration required.

|Steam Controller
|MOTION_STEAM_CONTROLLER
|https://github.com/kozec/sc-controller[sc-controller]
| link:motion_steam_controller/README.adoc[Configuration] is optional.

|Remote devices (e.g. smartphones)
|REMOTE_TOUCHPAD
|https://github.com/Unrud/remote-touchpad/[remote-touchpad]
|Requires link:remote_touchpad/README.adoc[configuration] to support browsers via URL or QR code.

|===

### Scripts
Scripts are located in the `bin/` directory. They are optional and not related to touch and motion control.

#### `extra-services`
* Script to manage the features of this project.
  This script is required only once to register the features as batocera services.
  It may be useful when something goes wrong.

#### `on-game-condition`
* A template for files in the `/userdata/system/scripts` directory.

#### `read-temperatures`
* A script to read system temperatures.

#### `squash-mount`
* A script to simplify (un)mounting squashfs roms for one or all systems to subdirectories of `/var/run/squashfs`.

#### `system-summary`
* A script to create a system summary (cpu, memory). May be bound to a key or controller button, e.g.:
+
./userdata/system/configs/multimedia_keys.conf
[source.conf]
----
KEY_F12 1 /userdata/extra/bin/system-summary | sed 's/Â°/ /' | HOME=/userdata/system XAUTHORITY=/var/lib/.Xauthority DISPLAY=:0.0 osd_cat -f -*-*-bold-*-*-*-38-120-*-*-*-*-*-* -cred -s 3 -d 4
----
