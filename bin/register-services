#!/bin/sh
set -eu

bin_dir="$(readlink -f "$(dirname "$0")")"
root_dir="$(readlink -f "$(dirname "${bin_dir}")")"
target=/userdata/system/services

if [ ! -d "${target}" ]; then
  mkdir -p "${target}"
fi

find "${root_dir}" -mindepth 1 -maxdepth 1 -type d | while read -r path; do
  if [ -e "${path}/start" ]; then
    service="$(basename "${path}" | tr - _)"
    ln -sf "${bin_dir}/.service" "${target}/${service}"
  fi
done
